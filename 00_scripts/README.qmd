---
title: Codebase documentation
format: md
execute:
  echo: false
  warning: false
  working-directory: "."
editor_options: 
  chunk_output_type: console
---

The SoIB codebase contains several functions relevant for the main analytical workflow but also many helper functions for both inside and outside this main pipeline. All these are outlined below.

All individual scripts are housed in `00_scripts/`. Numerical prefixes in filenames indicate where in the pipeline the scripts fall: 

- `00_*.R` Setup & helper functions
- `01_*.R` Main analysis 
- `02_*.R` Plotting 
- `10_*.R` Analyses from the Systematic Monitoring chapter of the report 
- `20_*.R` Website-specific steps and outputs 
- `30_*.R` Mass communication like acknowledgement certificates 

Scripts without prefixes may fall in multiple steps of the pipeline, from the main analyses steps to auxiliary outputs. The primary scripts for the main analysis are the ones referred to in order in `00_pipeline.R`.

## Helper functions

### `analyses_metadata`

```{r}
source(here::here("00_scripts/00_functions.R"))

n_col <- dim(pathfinder())[2]
n_mask <- dim(pathfinder() %>% select(contains("MASK")))[2]
```

This sets up the folder structure for the analytical workflow that spans multiple spatial scales (national, states, habitats) and analysis steps (and therefore folders and files). The main use of this feature is seamless operation of file paths. Therefore, the script `01_create_metadata.R` need only be run *when there is any change* to any folder/path structure. It also ensures the folder structures are matched, by creating the necessary folders that do not already exist (though it will not delete old folders). This script saves the metadata as `analyses_metadata.RData`.

All other times, the helper function `pathfinder()` can be used to obtain either the entire metadata base `pathfinder()` or the metadata for the spatial unit/mask of interest `pathfinder(mask)`. The metadata contains `{r} n_col - n_mask` columns of paths, which each correspond to a specific folder or file path, and `{r} n_mask` columns relating to the mask itself. It is best to simply select the required path directly from the output using `$`, like `pathfinder("none")$SOIBMAIN.PATH`.

### `soib_year_info`

Get year-related info for different SoIB contexts. e.g., get list of labels for time periods used in figures; get list of years considered for Current Annual Trends; get list of years for IUCN projection. Updated each time `readcleanrawdata()` run, i.e., `soib_year_info` is based on underlying eBird data!

Usage: `soib_year_info("latest_year")`

### `get_iucn_proj_cols`

Programmatically obtain list of column names for all IUCN projection years.

### `specname_to_india_checklist`

Convert eBird names to India Checklist names. Uses manually curated mapping sheet (`SoIB_mapping_2023.csv`).

### `get_latest_IUCN_status`

Add or update column with IUCN status of bird species. Uses manually curated mapping sheet (`SoIB_mapping_2023.csv`).

### `get_soib_status_cats`

SoIB status categories have changed since the first iteration in 2020. This function helps easily get the various status categories functionally, preventing the need to copy paste several strings every time.

Usage: `get_soib_status_cats("trend")`

### `ebird_tax_mapping`

eBird species names change every year, which proves difficult when working on annual updates. This function helps map these different names, using a single mapping file---and avoids having to read in the specific file every time (also minimising chances of error).

## Main analysis scripts

## One-time run scripts

